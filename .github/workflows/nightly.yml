name: Nightly
on:
  schedule:
    - cron: '0 0 * * *' # Every day at midnight
  pull_request:
    paths:
      - '.github/workflows/nightly.yml'

# This nightly test helps us to track changes on containerd on daily basis
# and enable us to quickly fix snapshotter when some of recent changes on
# containerd cause incompatibility with this snapshotter.
#
# TODO1(ktock): Output binaries if needed.
# TODO2(ktock): Ideally, this test should be invoked in containerd/containerd's CI on each PR.
#               This will make sure that each commit merged into containerd/containerd safely
#               works with stargz snapshotter.

env:
  DOCKER_BUILDKIT: 1
  DOCKER_BUILD_ARGS: --build-arg=CONTAINERD_VERSION=master # do tests with the latest containerd
  STARGZ_SNAPSHOTTER_PROJECT_ROOT: ${{ github.workspace }}/src/github.com/containerd/stargz-snapshotter

jobs:
  integration:
    runs-on: ubuntu-20.04
    name: Integration
    steps:
    - uses: actions/checkout@v2
      with:
        path: src/github.com/containerd/stargz-snapshotter
    - name: Run integration test
      run: make integration
      working-directory: src/github.com/containerd/stargz-snapshotter
